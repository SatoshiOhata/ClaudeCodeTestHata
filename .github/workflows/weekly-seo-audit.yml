name: Weekly SEO Audit

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  seo-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Run Claude SEO Audit
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          additional_permissions: "Bash(*),Write"
          prompt: |
            index.html のSEO監査を行い、結果をMarkdownファイルに保存してください。

            チェック項目：
            - タイトルタグ（60文字以内か）
            - メタディスクリプション（120文字以内、日本語）
            - 見出し構造（H1→H2→H3の階層）
            - 画像のalt属性
            - モバイルフレンドリー
            - Core Web Vitalsに影響する要素
            - アクセシビリティ

            各項目を「✅ 合格 / ⚠️ 改善推奨 / ❌ 要修正」で評価し、改善案を優先度順に提示してください。

            結果は必ず /home/runner/work/ClaudeCodeTestHata/ClaudeCodeTestHata/seo-report.md に保存してください。
          claude_args: "--max-turns 5"

      - name: Create Issue from Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            let body = 'SEO監査レポートファイルが見つかりませんでした。';
            try {
              body = fs.readFileSync('seo-report.md', 'utf8');
            } catch (e) {
              console.log('Report file not found:', e.message);
            }
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `週次SEO監査レポート: ${date}`,
              body: body.slice(0, 65000),
              labels: ['seo-audit']
            });
