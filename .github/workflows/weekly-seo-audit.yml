name: Weekly SEO Audit

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  seo-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Run Claude SEO Audit
        id: audit
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            index.html のSEO監査を行ってください。
            チェック項目：タイトルタグ、メタディスクリプション、見出し構造、画像alt属性、モバイルフレンドリー、Core Web Vitals、アクセシビリティ
            各項目を「✅ 合格 / ⚠️ 改善推奨 / ❌ 要修正」で評価し、改善案を優先度順に提示してください。
            結果はMarkdown形式で出力してください。
          claude_args: "--max-turns 5"

      - name: Create Issue
        uses: actions/github-script@v7
        env:
          AUDIT_RESULT: ${{ steps.audit.outputs.result }}
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const body = process.env.AUDIT_RESULT || 'SEO監査の結果を取得できませんでした。Actionsログを確認してください。';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `週次SEO監査レポート: ${date}`,
              body: body.slice(0, 65000),
              labels: ['seo-audit']
            });
